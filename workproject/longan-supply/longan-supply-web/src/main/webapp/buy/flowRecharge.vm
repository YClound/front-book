<!DOCTYPE html>
<html lang="zh-CN">
#head("流量充值")

<body>
	
	#header()

	<div class="container main-container ">
		<div class="row-fluid">
			#sidebar('flow')
			
			<div class="span10">
				
				#stepBarPhone(1)
				
				<div class="sortable row-fluid">
					<div class="span12">
						
						#flowTab('flow')
						
						<div class="content-main">
						
							<form id="flowRechargeForm" class="form-horizontal" action="flowRechargeConfirm.htm" method="post">
							<fieldset>
							  <div class="control-group recharge-form">
								<label class="control-label" for="phoneNum">号码：</label>
								<div class="controls">
								  <div class="input-prepend">
									<input id="phoneNum" name="uid" maxlength="11" type="text">
								  </div>
								  <p id="phoneInfo" class="help-inline red"> 请输入充值号码 </p>
								</div>
							  </div>
							  
							  <div class="control-group">
								<label class="control-label" for="appendedInput">类型：</label>
								<div class="controls">
										<div class="phone-faceprice" id ="types">
											<ul>
												<li class="itemRadio current"><input type="radio"  name="typeRadio" id="typeRadio1" value="0" checked="checked" ><label for="typeRadio1"> <span class="item">全国</span></label></li>
												<li class="itemRadio"> <input type="radio"   name="typeRadio" id="typeRadio2" value="1" > <label for="typeRadio2"><span class="item">省内</span></label></li>
											</ul>
							            </div>
								</div>
							  </div>
							  							  
							  <div class="control-group" style="margin-bottom: 5px;">
								<label class="control-label" for="appendedInput">面值：</label>
								<div class="controls">
										<div class="phone-faceprice" id ="items">
											<ul>
<!-- 												<li class="itemRadio current"><input type="radio"  name="itemRadio" datas="60M" checked="checked" id="itemRadio1"  value="pre"><label for="itemRadio1"> <span class="item">60M</span></label></li> -->
<!-- 												<li class="itemRadio"> <input type="radio"  datas="100M" name="itemRadio" id="itemRadio2" value="pre"> <label for="itemRadio2"><span class="item">100M</span></label></li> -->
<!-- 												<li class="itemRadio"> <input type="radio" datas="300M" name="itemRadio" id="itemRadio3" value="pre"><label for="itemRadio3"> <span class="item">300M</span></label></li> -->
											</ul>
							            </div>
								</div>
							  </div>
							  
							  <div class="control-group recharge-form">
								<label class="control-label" for="facePriceShow">价格：</label>
								<div class="controls">
								  <div class="input-prepend">
									<input id="priceShow" name="price" class= "input-mini" readonly="readonly" size="8" type="text">
									<span class="help-inline red" id="priceInfo"></span>
								  </div>								
								</div>
							  </div>							  
							  
							  <div class="control-group">
							  <div class="controls">
								<button id="rechargeButton" type="submit" class="btn disabled" data-loading-text="处理中...">立即充值</button>
								</div>
							  </div>							  
								
							</fieldset>
						</form>
						</div>						
						
					</div>
				</div>

			</div>

		</div>
	</div>
	#footer()
	
	<script src="$!{assetsServer}assets/js/aes.js"></script>
	<script src="$!{assetsServer}assets/js/md5.js"></script>
	<script src="$!{assetsServer}assets/js/mode-ecb-min.js"> </script>
	<script src="$!{assetsServer}assets/js/jquery.validate.min.js"></script>
	
	<script type="text/javascript">
		var itemMap;
		
		function removeCurrentItem(){
			$("#items .current").removeClass("current");
		}
		
		function removeCurrentType(obj){
			$("#types .current").removeClass("current");
		}
		
		function addCurrent(obj){
			obj.addClass("current");
		}
		
		function initItem(){
			var allItems = $('#items');
			allItems.children('ul').html("");
			allItems.children('ul').append("<li class='itemRadio current'> <input type='radio' datas='60M' name='itemRadio' id='itemRadio1' value='pre'> <label for='itemRadio1'><span class='item'>60M</span></label></li>\n");
			allItems.children('ul').append("<li class='itemRadio'> <input type='radio' datas='100M' name='itemRadio' id='itemRadio2' value='pre'> <label for='itemRadio2'><span class='item'>100M</span></label></li>\n");
			allItems.children('ul').append("<li class='itemRadio'> <input type='radio' datas='300M' name='itemRadio' id='itemRadio3' value='pre'> <label for='itemRadio3'><span class='item'>300M</span></label></li>\n");
		}
		
		function changeItemRadio(){
			var itemRadios= $('input[name="itemRadio"]');
			var checkedPro =  $("input[name='itemRadio']:checked").attr("datas");
			var checkedType =  $("input[name='typeRadio']:checked").val();
			
		
			var allItems = $('#items');
			allItems.children('ul').html("");
			var i = 0;
			$.each(itemMap[checkedType],function(k,v){
				i++;
				allItems.children('ul').append("<li class='itemRadio'> <input type='radio' datas='" 
						+ k +"' name='itemRadio' id='itemRadio" 
						+ i + "' value='pre'> <label for='itemRadio" 
						+ i + "'><span class='item'>" 
						+ k + "</span></label></li>\n");
			});
			
			var flag = false;
			if(i==0){
				initItem();
				$("#priceInfo").html("抱歉该面额，未上架");
			}
			
			$("#items li").bind("click", clickCurrentItem);
			
			bindPrice();
			
			var typeRadios= $('input[name="typeRadio"]');
			typeRadios.unbind("click",changeItemClickType); 
			typeRadios.bind("click",changeItemClickType);
			
			itemRadios= $('input[name="itemRadio"]');
			$.each(itemRadios,function(){
				var radio = $(this);
				var itemPro = radio.attr("datas");
				var items = itemMap[checkedType];
				
				var item = items[itemPro];
				if(item != null){
					$(this).val(item.id);
					if(checkedPro==itemPro){
						$(this).attr("checked","checked");
						$(this).trigger("click");
						flag = true;
					}
				}else{
					$(this).val("pre");
					if(checkedPro==itemPro){
						$(this).attr("checked","checked");
						$(this).trigger("click");
						flag = true;
					}
				}
			});
			
			if(!flag){
				$("#items li:first-child input").attr("checked","checked");
				$("#items li:first-child input").trigger("click");
			}
		}
		
		
		
		
		function changeItemClickType(){
			var checkedType =  $("input[name='typeRadio']:checked").val();
			var checkedItem =  $("input[name='itemRadio']:checked").attr("datas");
			var allItems = $('#items');
			var i = 0;
			allItems.children('ul').html("");
			$.each(itemMap[checkedType],function(k,v){
				i++;
				allItems.children('ul').append("<li class='itemRadio'> <input type='radio' datas='" 
						+ k +"' name='itemRadio' id='itemRadio" 
						+ i + "' value='pre'> <label for='itemRadio" 
						+ i + "'><span class='item'>" 
						+ k + "</span></label></li>\n");
			});
			
			var flag = false;
			if(i==0){
				initItem();
				$("#priceInfo").html("抱歉该面额，未上架");
			}
			
			$("#items li").bind("click", clickCurrentItem);
			var itemRadios= $('input[name="itemRadio"]');
			itemRadios.unbind("click",changePriceClickItem); 
			itemRadios.bind("click",changePriceClickItem);
			
			$.each(itemRadios,function(){
				var radio = $(this);
				var itemPro = radio.attr("datas");
				var items = itemMap[checkedType];
				
				var item = items[itemPro];
				if(item != null){
					$(this).val(item.id);
					if(checkedItem==itemPro){
						flag = true;
						$(this).attr("checked","checked");
						$(this).trigger("click");
					}
				}else{
					$(this).val("pre");
					if(checkedItem==itemPro){
						$(this).attr("checked","checked");
						$(this).trigger("click");
						flag = true;
					}
				}
			});

			if(!flag){
				$("#items li:first-child input").attr("checked","checked");
				$("#items li:first-child input").trigger("click");
			}
		}
		
		function bindPrice(){
			var itemRadios= $('input[name="itemRadio"]');
			var typeRadios= $('input[name="typeRadio"]');
			
			itemRadios.unbind("click",changePriceClickItem); 
			itemRadios.bind("click",changePriceClickItem);
			
			typeRadios.unbind("click",changePriceClickType); 
			typeRadios.bind("click", changePriceClickType);
		}
		
		function changePriceClickItem(){
			var checkedItem =  $("input[name='itemRadio']:checked").attr("datas");
			var checkedType =  $("input[name='typeRadio']:checked").val();
			if(checkedItem==null || checkedType == null){
				return;
			}
			var items = itemMap[checkedType];
			var item = items[checkedItem];
			if(item!=null){
				$('#priceShow').val(item.itemSalesPriceDesc);
				$("#priceInfo").html("");
				passButton();
			}else{
				$('#priceShow').val("");
				$("#priceInfo").html("抱歉该面额，未上架");
				unPassButton();
			}
		}
		
		function changePriceClickType(){
			var checkedItem =  $("input[name='itemRadio']:checked").attr("datas");
			var checkedType =  $("input[name='typeRadio']:checked").val();
			if(checkedItem==null || checkedType == null){
				return;
			}
			
			var items = itemMap[checkedType];
			var item = items[checkedItem];
			
			if(item!=null){
				$('#priceShow').val(item.itemSalesPriceDesc);
				$("#priceInfo").html("");
				passButton();
			}else{
				$('#priceShow').val("");
				$("#priceInfo").html("抱歉该面额，未上架");
				unPassButton();
			}
		}
		
		function passButton(){
			$('#rechargeButton').attr("class","goto-recharge");
			$("#rechargeButton").attr("disabled",false);
		}
		
		function unPassButton(){
			$('#rechargeButton').attr("class","btn disabled");
			$("#rechargeButton").html("立即充值");
			$("#rechargeButton").attr("disabled",true);
		}

		function resetForm(){
			$("#priceInfo").html("");
			$('#priceShow').val("");
			var itemRadios= $('input[name="itemRadio"]');
			
			$.each(itemRadios,function(){
				 $(this).val("pre");
			});			
			unPassButton();
		}
	
		$().ready(function() {
			$("#flowRechargeForm").validate({
				focusInvalid:false, 
			    submitHandler: function(form){ 
			    	if(!checkForm()){
			    		return;
			    	}
			        form.submit();  
			    },
			});
			
			resetForm();
			
			var resetflag = true;
			
			$("#phoneNum").bind("propertychange input", resetItem);
			
			$("#phoneNum").bind("propertychange input",phoneQuery);
			
			function resetItem () {
				 if (document.createEventObject){
					 	//ie10 event is null
						if(event!=null && event.propertyName.toLowerCase() != "value"){
							//alert("fuck ie " + event.propertyName);
							return;
						} 
				}
				if(resetflag){
					return;
				}
				itemMap = "";
				$('input[name="typeRadio"]').unbind("click");
				resetForm();
				initItem();
				$("#items li").bind("click", clickCurrentItem);
				$("#types li").bind("click", clickCurrentType);
				resetflag = true;
			}
			
			function  phoneQuery () { 
				var rule = "^1(3[0-9]|5[0-35-9]|8[0235-9])\\d{8}$";
				var phone = $("#phoneNum").val();
				var flag = new RegExp(rule).test(phone);
				 if (document.createEventObject){
					 	//ie10 event is null
						if(event!=null && event.propertyName.toLowerCase() != "value"){
							//alert("fuck ie " + event.propertyName);
							return;
						} 
				}
				if(flag){
					resetflag = false;
					$.ajax({
						url:"$!{context.contextPath}api/flowQuery.htm?uid=" +phone,
						async:true,
						dataType:"json",
						beforeSend:function(){
							resetForm();
						},
						success: function(data, textStatus){
							var status = data.status;
							if(data == "" || data == undefined || data == null){
								$("#phoneInfo").html("网络连接超时");
								return;
							}
							if(status == "error"){
								$("#phoneInfo").html(data.errorMsg);
								return;
							}
							var flowQueryWeb = data.module;
							$("#phoneInfo").html(flowQueryWeb.mobileBelong.provinceName + " " + flowQueryWeb.mobileBelong.carrierName);
							itemMap = flowQueryWeb.itemMap;
							if(itemMap == null ){
								$("#phoneInfo").html("商品已下架，或者不存在");
								return;
							}
							var i = 0;
							$.each(itemMap,function(k,v){
								 i++;
							});
							
							if(i<=0){ 
								$("#phoneInfo").html("商品已下架，或者不存在");
								return;
							}
							changeItemRadio();
						}
					});
				}else{
					resetForm();
					$("#phoneInfo").html("请输入正确的手机号");
				}
			}
			
			initItem();
			
			$("#items li").bind("click", clickCurrentItem);
			
			$("#types li").bind("click", clickCurrentType);			
			
			$('#phoneNum').val("");
		});
		
		
		
		function clickCurrentItem () {
			if(document.getElementById("btnGroup") != this){
				removeCurrentItem();
				addCurrent($(this));
			}
		}
		
		function clickCurrentType(){
			if(document.getElementById("btnGroup") != this){
				removeCurrentType();
				addCurrent($(this));
			}
		}
		
		function checkForm(){
			var rule = "^1(3[0-9]|5[0-35-9]|8[0235-9])\\d{8}$";
			var phone = $("#phoneNum").val();
			var flag = new RegExp(rule).test(phone);
			if(!flag){
				$("#phoneInfo").html("请输入正确的手机号");
				return false;
			}
			var itemFacePrice = $("input[name='itemRadio']:checked").attr("datas");
			if(itemFacePrice == null){
				$("#phoneInfo").html("必须选择充值面额");
				return false;
			}
			
			var radioValue = $("input[name='itemRadio']:checked").val();
			if(radioValue == "pre"){
				//$("#phoneInfo").html("请重新输入手机号");
				return false;
			}
			$("#rechargeButton").html("提交中..");
			$("#rechargeButton").attr("disabled",true);
			return true;
		}
	</script>
	
	#modalPayPwdEdit()
</body>
</html>
