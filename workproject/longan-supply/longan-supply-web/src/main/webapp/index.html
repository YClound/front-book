<!DOCTYPE html>
<html lang="zh-CN">
#head()

#macro(showLoginMessage $message)
 #if($!message)
    <div id="headInfo" class="alter-header center" style="color#ff0000">$!message</div>
 #else
    <div id="headInfo" class="alter-header center">登录</div>    
 #end
#end
<body style="background-color: #fff;">
    <div class="logo-box">
      <img src="assets/img/logo.png">
    </div>
    <div class="container-fluid index-mbanner">
        <div class="row-fluid">
            <div class="row-fluid">
                <div class="index-container">
                    <div class="index-cell"></div>
                </div>
            </div>

            <div class="row-fluid">
                <div class="well  login-box login-box-tangtang">
                    #showLoginMessage($!message)
                    <form id="loginForm" action="login.htm" class="login-form" method="post">
                        <input id="encodePwd" type="hidden" name="pwd">
                        <input id="token" type="hidden" name="token">
                        <input id="ts" type="hidden" name="ts">
                        
                        <fieldset>
                            <div class="control-group" title="用户名" data-rel="tooltip">
                                <span class="input-prepend span12"> <span class="add-on">
                                <i class="icon-user"></i>
                                </span>
                                    <input autofocus type="text" id="loginId" name="loginId" value="$!loginForm.loginId" class="input-medium" placeholder="用户名">
                                </span>
                            </div>
                            <div class="clearfix"></div>

                            <div class="control-group" title="密码" data-rel="tooltip">
                                <span class="input-prepend span12"> <span class="add-on"><i
                                        class="icon-lock"></i></span><input id="pwd" name="oriPwd" type="password"
                                    class="input-medium" placeholder="密码">
                                </span>
                            </div>
                            <div class="clearfix"></div>

                            <div class="login-forgetpwd controls-row">
                                <span style="color: #ff5c00;"> 忘记密码？</span>
                            </div>
                            <div class="clearfix"></div>

                            <div class="control-group #if(!$!checkCodeFlag) hidden #end" title="验证码" data-rel="tooltip">
                                <span class="input-prepend span7"> <span class="add-on"><i
                                        class="icon-lock"></i></span><input type="text" name="checkCode"
                                    class="input-small" maxlength="4" placeholder="验证码" />
                                </span> <span class="span3"> <img id="imgCheckCode"
                                    class="login-verify img-rounded"></span>

                            </div>
                            <p class="clearfix" />
                            <p class="center">
                                <button type="submit" class="btn btn-primary">登录</button>
                            </p>

                            <p class="clearfix" />
                            <p class="left">
                                还没有帐号？<a href="user/register.htm" class="goto-register">立即注册</a>
                            </p>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>


    #footer()
    
    #set($assetsServer = $context.assetsServer)
    #set($contextPath = $context.contextPath)
    <script src="$!{assetsServer}assets/js/aes.js"></script>
    <script src="$!{assetsServer}assets/js/md5.js"></script>
    <script src="$!{assetsServer}assets/js/mode-ecb-min.js"> </script>
    <script src="$!{assetsServer}assets/js/jquery.validate.min.js"></script>
    
    <script type="text/javascript">
        
    
        $().ready(function() {
            $("#loginForm").validate({
                focusInvalid:false, 
                submitHandler: function(form){  
                    preLogin();
                    form.submit();
                },
                rules : {
                    loginId : "required",
                    oriPwd : {
                        required: true,
                        minlength : 6
                    },
                    checkCode: {
                        required: #if($!checkCodeFlag) true #else false #end,
                        minlength : 4
                    }
                },
                messages: {
                    loginId: "请输入登录名",
                    oriPwd:{
                        required: "请输入密码",
                        minlength : "密码长度必须是6位以上"
                    },
                    checkCode:{
                        required: "请输入验证码",
                        minlength : "验证码格式错误"
                    }
                }
            });
            
            #if($!checkCodeFlag)
                
                function getCheckCode(){
                var loginId = jQuery('#loginId').val();
                var imgUrl = "$!{contextPath}checkCode.htm?loginId=" + loginId + "&ts=" + new Date().getTime();
                jQuery('#imgCheckCode').attr("src",imgUrl);
            }
                
                getCheckCode();
                
                jQuery('#imgCheckCode').on("click",getCheckCode);
            #end
        });
        
        function preLogin(){
            var token;
            var ts;
            $.ajax({
                url:"$!{context.contextPath}api/getLoginToken.htm",
                async:false,
                dataType:"json",
                beforeSend:function(){
                    //nothing
                },
                success: function(data, textStatus){
                    if(data == "" || data == undefined || data == null){
                        $("#headInfo").html("网络连接超时,请稍候再试");
                        return;
                    }
                    var status = data.status;
                    if(status == "error"){
                        $("#headInfo").html(data.errorMsg);
                        return;
                    }
                    var loginToken = data.module;
                    
                    token = loginToken.token;
                    ts = loginToken.ts;
                }
            });
            
            var pwd = jQuery('#pwd').val();

            //console.log("0:"+token);
            pwd =  CryptoJS.MD5(pwd+"longan_login");
            //console.log("1:"+pwd);
            pwd = pwd + "_" + ts;
            //console.log("2:"+pwd);
            var keyHex = CryptoJS.enc.Utf8.parse(token);
            //console.log("3:"+keyHex);
            
            var encrypted = CryptoJS.AES.encrypt(pwd, keyHex, {  
                mode: CryptoJS.mode.ECB,
                padding: CryptoJS.pad.Pkcs7
            });
            
            //console.log("4:"+encrypted);
            //console.log("5:"+encrypted.ciphertext.toString(CryptoJS.enc.Base64));
            jQuery('#encodePwd').val(encrypted.ciphertext.toString(CryptoJS.enc.Base64));
            jQuery('#pwd').val("");
        }
        
    </script>
</body>
</html>
