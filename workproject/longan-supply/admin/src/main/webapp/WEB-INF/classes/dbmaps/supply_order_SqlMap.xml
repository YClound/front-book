<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="supply_order">
	<resultMap id="supplyOrderResult" class="com.longan.biz.dataobject.SupplyOrder">
		<result column="id" jdbcType="BIGINT" property="id" />
		<result column="gmt_create" property="gmtCreate" />
		<result column="gmt_modify" property="gmtModify" />
		<result column="biz_order_id" property="bizOrderId" />
		<result column="biz_id" property="bizId" />
		<result column="item_supply_id" property="itemSupplyId" />
		<result column="stock_id" property="stockId" />
		<result column="user_id" property="userId" />
		<result column="item_id" property="itemId" />
		<result column="item_name" property="itemName" />
		<result column="item_face_price" property="itemFacePrice" />
		<result column="item_uid" property="itemUid" />
		<result column="item_ext1" property="itemExt1" />
		<result column="item_ext2" property="itemExt2" />
		<result column="item_ext3" property="itemExt3" />
		<result column="amount" property="amount" />
		<result column="amt" property="amt" />
		<result column="lock_oper_id" property="lockOperId" />
		<result column="deal_oper_id" property="dealOperId" />
		<result column="supply_trader_id" property="supplyTraderId" />
		<result column="supply_trader_name" property="supplyTraderName" />
		<result column="supply_cost_time" property="supplyCostTime" />
		<result column="supply_type" property="supplyType" />
		<result column="supply_face_price" property="supplyFacePrice" />
		<result column="supply_cost_price" property="supplyCostPrice" />
		<result column="supply_actual_cost" property="supplyActualCost" />
		<result column="supply_status" property="supplyStatus" />
		<result column="final_type" property="finalType" />
		<result column="repeat_type" property="repeatType" />
		<result column="combine_type" property="combineType" />
		<result column="manual_type" property="manualType" />
		<result column="upstream_serialno" property="upstreamSerialno" />
		<result column="upstream_date" property="upstreamDate" />
		<result column="upstream_memo" property="upstreamMemo" />
	</resultMap>

	<sql id="supplyOrderFullColumns">
		id, gmt_create, gmt_modify, biz_order_id, biz_id,
		item_supply_id, stock_id, user_id,
		item_id, item_name,
		item_face_price,item_uid, item_ext1, item_ext2, item_ext3,
		amount, amt,
		lock_oper_id, deal_oper_id,
		supply_trader_id,
		supply_trader_name,
		supply_cost_time, supply_type,
		supply_face_price,
		supply_cost_price,
		supply_actual_cost, supply_status,
		final_type,
		repeat_type,
		combine_type,manual_type,upstream_serialno,upstream_date,upstream_memo
	</sql>

	<insert id="insert" parameterClass="com.longan.biz.dataobject.SupplyOrder">
		insert into
		supply_order (
		<include refid="supply_order.supplyOrderFullColumns" />
		)
		values
		(id,now(),now(),
		#bizOrderId#,
		#bizId#,
		#itemSupplyId#,
		#stockId#,
		#userId#,
		#itemId#,
		#itemName#,
		#itemFacePrice#,
		#itemUid#,#itemExt1#,#itemExt2#,#itemExt3#,
		#amount#,#amt#,#lockOperId#,#dealOperId#,#supplyTraderId#,#supplyTraderName#,#supplyCostTime#,
		#supplyType#,#supplyFacePrice#,#supplyCostPrice#,#supplyActualCost#,#supplyStatus#,#finalType#,
		#repeatType#,
		#combineType#,#manualType#,#upstreamSerialno#,#upstreamDate#,#upstreamMemo#)
		<selectKey resultClass="Long" keyProperty="id">
			SELECT
			LAST_INSERT_ID()
		</selectKey>
	</insert>

	<!-- <select id="queryListUnDone" resultMap="taskResult"> -->
	<!-- select -->
	<!-- <include refid="task.taskFullColumns" /> -->
	<!-- from task -->
	<!-- where status = 1 and commit_time &lt; -->
	<!-- DATE_ADD(NOW(),INTERVAL -->
	<!-- #value# SECOND); -->
	<!-- </select> -->

	<update id="updateSupplyOrder">
		update supply_order set gmt_modify = now()
		<dynamic>
			<isNotNull prepend="," property="bizOrderId">
				biz_order_id =
				#bizOrderId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="bizId">
				biz_id = #bizId:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="itemSupplyId">
				item_supply_id =
				#itemSupplyId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="stockId">
				stock_id = #stockId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="userId">
				user_id = #userId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="itemId">
				item_id = #itemId:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="itemName">
				item_name =
				#itemName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="itemFacePrice">
				item_face_price =
				#itemFacePrice:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="itemUid">
				item_uid =
				#itemUid#
			</isNotNull>
			<isNotNull prepend="," property="itemExt1">
				item_ext1 =
				#itemExt1#
			</isNotNull>
			<isNotNull prepend="," property="itemExt2">
				item_ext2 =
				#itemExt2#
			</isNotNull>
			<isNotNull prepend="," property="itemExt3">
				item_ext3 =
				#itemExt3#
			</isNotNull>
			<isNotNull prepend="," property="amount">
				amount = #amount:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="lockOperId">
				lock_oper_id =
				#lockOperId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="dealOperId">
				deal_oper_id =
				#dealOperId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyTraderId">
				supply_trader_id =
				#supplyTraderId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyTraderName">
				supply_trader_name =
				#supplyTraderName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="supplyCostTime">
				supply_cost_time =
				#supplyCostTime:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyType">
				supply_type =
				#supplyType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyFacePrice">
				supply_face_price =
				#supplyFacePrice:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyCostPrice">
				supply_cost_price =
				#supplyCostPrice:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyActualCost">
				supply_actual_cost =
				#supplyActualCost:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyStatus">
				supply_status =
				#supplyStatus:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="finalType">
				final_type =
				#finalType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="repeatType">
				repeat_type =
				#repeatType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="combineType">
				combine_type =
				#combineType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="manualType">
				manual_type =
				#manualType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="upstreamSerialno">
				upstream_serialno =
				#upstreamSerialno#
			</isNotNull>
			<isNotNull prepend="," property="upstreamDate">
				upstream_date =
				#upstreamDate#
			</isNotNull>
			<isNotNull prepend="," property="upstreamMemo">
				upstream_memo =
				#upstreamMemo#
			</isNotNull>
		</dynamic>
		where id = #id:BIGINT#
	</update>


	<sql id="whereConditions">
		<dynamic prepend="where">
			<isNotEmpty prepend="and" property="id">
				id =
				#id#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="userId">
				user_id =
				#userId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="supplyStatus">
				supply_status =
				#supplyStatus#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="startGmtCreate">
				gmt_create &gt;
				#startGmtCreate#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="endGmtCreate">
				gmt_create &lt;
				DATE_ADD(#endGmtCreate#,INTERVAL 1 DAY)
			</isNotEmpty>
			<isNotEmpty prepend="and" property="itemId">
				item_id =
				#itemId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="itemUid">
				item_uid =
				#itemUid#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="bizId">
				biz_id =
				#bizId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="supplyTraderId">
				supply_trader_id =
				#supplyTraderId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="bizOrderId">
				biz_order_id =
				#bizOrderId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="lockOperId">
				lock_oper_id =
				#lockOperId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="dealOperId">
				deal_oper_id =
				#dealOperId#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="upstreamSerialno">
				upstream_serialno =
				#upstreamSerialno#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="lessCostTime">
				(supply_cost_time &lt;=
				#lessCostTime# and supply_cost_time IS NOT NULL)
			</isNotEmpty>
			<isNotEmpty prepend="and" property="moreCostTime">
				(supply_cost_time &gt;=
				#moreCostTime# and supply_cost_time IS NOT NULL)
			</isNotEmpty>
			<isNotEmpty prepend="and" property="supplyType">
				supply_type =
				#supplyType#
			</isNotEmpty>
			<isNotEmpty prepend="and" property="statusList">
				supply_status in
				<iterate property="statusList" open="(" conjunction=","
					close=")">
					#statusList[]#
				</iterate>
			</isNotEmpty>
		</dynamic>
	</sql>
	<select id="selectByPrimaryKey" parameterClass="com.longan.biz.dataobject.SupplyOrder"
		resultMap="supplyOrderResult">
		select
		<include refid="supply_order.supplyOrderFullColumns" />
		from supply_order
		where id =
		#id:BIGINT#
	</select>
	<select id="queryByPage" resultMap="supplyOrderResult">
		select
		<include refid="supply_order.supplyOrderFullColumns" />
		from supply_order
		<include refid="supply_order.whereConditions" />
		ORDER BY
		gmt_create DESC LIMIT #startRow#,#pageSize#
	</select>


	<select id="queryByPageCount" resultClass="java.lang.Integer">
		SELECT count(*)
		from supply_order
		<include refid="supply_order.whereConditions" />
	</select>


	<!-- <update id="updateTaskById"> -->
	<!-- update task -->
	<!-- set gmt_modify = now(),commit_time = -->
	<!-- #commitTime# -->
	<!-- where id = #id# and status = 1 -->
	<!-- </update> -->

	<select id="getSupplyOrderById" resultMap="supplyOrderResult">
		SELECT
		<include refid="supplyOrderFullColumns" />
		from supply_order
		where id = #supplyOrderId#
	</select>


	<update id="updateSupplyOrderCheckStatus">
		update supply_order set gmt_modify = now()
		<dynamic>
			<isNotNull prepend="," property="supplyOrder.bizOrderId">
				biz_order_id =
				#supplyOrder.bizOrderId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.bizId">
				biz_id =
				#supplyOrder.bizId:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemSupplyId">
				item_supply_id =
				#supplyOrder.itemSupplyId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.stockId">
				stock_id =
				#supplyOrder.stockId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.userId">
				user_id =
				#supplyOrder.userId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemId">
				item_id =
				#supplyOrder.itemId:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemName">
				item_name =
				#supplyOrder.itemName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemFacePrice">
				item_face_price =
				#supplyOrder.itemFacePrice:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemUid">
				item_uid =
				#supplyOrder.itemUid#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemExt1">
				item_ext1 =
				#supplyOrder.itemExt1#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemExt2">
				item_ext2 =
				#supplyOrder.itemExt2#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.itemExt3">
				item_ext3 =
				#supplyOrder.itemExt3#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.amount">
				amount =
				#supplyOrder.amount:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.amt">
				amt =
				#supplyOrder.amt:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.lockOperId">
				lock_oper_id =
				#supplyOrder.lockOperId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.dealOperId">
				deal_oper_id =
				#supplyOrder.dealOperId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyTraderId">
				supply_trader_id =
				#supplyOrder.supplyTraderId:BIGINT#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyTraderName">
				supply_trader_name =
				#supplyOrder.supplyTraderName:VARCHAR#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyCostTime">
				supply_cost_time =
				#supplyOrder.supplyCostTime:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyType">
				supply_type =
				#supplyOrder.supplyType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyFacePrice">
				supply_face_price =
				#supplyOrder.supplyFacePrice:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyCostPrice">
				supply_cost_price =
				#supplyOrder.supplyCostPrice:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyActualCost">
				supply_actual_cost =
				#supplyOrder.supplyActualCost:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.supplyStatus">
				supply_status =
				#supplyOrder.supplyStatus:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.finalType">
				final_type =
				#supplyOrder.finalType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.repeatType">
				repeat_type =
				#supplyOrder.repeatType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.combineType">
				combine_type =
				#supplyOrder.combineType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.manualType">
				manual_type =
				#supplyOrder.manualType:INTEGER#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.upstreamSerialno">
				upstream_serialno =
				#supplyOrder.upstreamSerialno#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.upstreamDate">
				upstream_date =
				#supplyOrder.upstreamDate#
			</isNotNull>
			<isNotNull prepend="," property="supplyOrder.upstreamMemo">
				upstream_memo =
				#supplyOrder.upstreamMemo#
			</isNotNull>
		</dynamic>
		where id = #supplyOrder.id:BIGINT#
		<isNotEmpty prepend="and" property="statusList">
			supply_status in
			<iterate property="statusList" open="(" conjunction=","
				close=")">
				#statusList[]#
			</iterate>
		</isNotEmpty>
	</update>

	<select id="queryByExport" resultMap="supplyOrderResult">
		SELECT
		<include refid="supply_order.supplyOrderFullColumns" />
		FROM supply_order
		<include refid="supply_order.whereConditions" />
		ORDER BY
		gmt_create
	</select>


	<update id="lockSupplyOrder" parameterClass="com.longan.biz.dataobject.SupplyOrder">
		update supply_order
		set
		gmt_modify = now(),lock_oper_id = #lockOperId#,supply_status = 4
		where id =
		#id# and supply_status = 1
	</update>

	<update id="unLockSupplyOrder" parameterClass="com.longan.biz.dataobject.SupplyOrder">
		update
		supply_order
		set
		gmt_modify = now(),lock_oper_id = NULL,supply_status =
		1
		where id =
		#id# and
		supply_status = 4
	</update>

	<update id="confirmSupplyOrder" parameterClass="com.longan.biz.dataobject.SupplyOrder">
		update
		supply_order
		set
		gmt_modify = now(),deal_oper_id =
		#dealOperId#,supply_status =
		2,supply_cost_time =
		#supplyCostTime#,upstream_serialno=#upstreamSerialno#
		where id =
		#id#
		and
		(supply_status = 9 or (supply_status = 4 and
		lock_oper_id =
		#dealOperId#))
	</update>
	<update id="cancelSupplyOrder" parameterClass="com.longan.biz.dataobject.SupplyOrder">
		update
		supply_order
		set
		gmt_modify = now(),deal_oper_id =
		#dealOperId#,supply_status = 3
		where id =
		#id# and (supply_status = 1 or
		supply_status = 9 or
		(supply_status = 4 and lock_oper_id =
		#dealOperId#))
	</update>

	<update id="unConfirmSupplyOrder" parameterClass="com.longan.biz.dataobject.SupplyOrder">
		update
		supply_order
		set
		gmt_modify = now(),supply_status =
		9,upstream_serialno=#upstreamSerialno#
		where id =
		#id# and
		(supply_status = 4 and
		lock_oper_id =
		#dealOperId#)
	</update>



</sqlMap>