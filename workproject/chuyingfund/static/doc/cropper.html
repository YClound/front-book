

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <title>图片剪裁</title>
    <link rel="stylesheet" href="../assets/css/mobile/base.css">
    
 
    <style>
    .wrapper {
    max-width: 640px;
    margin: 0 auto;
    min-height: 100%;
    height: 100%;
}


.modal-change-avatar .up-avatar{margin:auto}
.modal-change-avatar .up-avatar .crop-box{text-align:center}
.modal-change-avatar .crop-box{background:#e6e6e6;min-height:410px}
.modal-change-avatar .crop-wrap{width:378px}
.modal-change-avatar .preview-box{background-color:#f9f9f9}
.modal-change-avatar .preview-box>div{margin:20px auto;overflow:hidden;border-radius:8%}
.modal-change-avatar .preview-box>div:first-child{margin-top:0}
.modal-change-avatar .preview-box .large{width:150px;height:150px}
.modal-change-avatar .preview-box .medium{width:110px;height:110px}
.modal-change-avatar .preview-box .small{width:80px;height:80px}
.modal-change-avatar .toolbar{display:none}
/*!
 * Cropper v1.0.0-rc.1
 * https://github.com/fengyuanchen/cropper
 *
 * Copyright (c) 2014-2015 Fengyuan Chen and contributors
 * Released under the MIT license
 *
 * Date: 2015-09-05T04:29:22.355Z
 */
.cropper-container{position:relative;overflow:hidden;font-size:0;line-height:0;-ms-touch-action:none;touch-action:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;direction:ltr!important;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
.cropper-container img{display:block;width:100%;min-width:0!important;max-width:none!important;height:100%;min-height:0!important;max-height:none!important;image-orientation:0deg!important}
.cropper-canvas,.cropper-crop-box,.cropper-drag-box,.cropper-modal{position:absolute;top:0;right:0;bottom:0;left:0}
.cropper-drag-box{background-color:#fff;opacity:0;filter:alpha(opacity=0)}
.cropper-dashed,.cropper-modal{opacity:.5;filter:alpha(opacity=50)}
.cropper-modal{background-color:#000}
.cropper-view-box{display:block;width:100%;height:100%;overflow:hidden;outline:#69f solid 1px;outline-color:rgba(102,153,255,.75)}
pre,textarea{overflow:auto}
.btn:active,.btn:focus,.btn:hover,.webuploader-pick:active,.webuploader-pick:focus,.webuploader-pick:hover,a:active,a:hover,button:active,button:focus,button:hover{outline:0}
.cropper-dashed{position:absolute;border:0 dashed #eee}
.cropper-dashed.dashed-h{top:33.33333%;left:0;width:100%;height:33.33333%;border-top-width:1px;border-bottom-width:1px}
.cropper-dashed.dashed-v{top:0;left:33.33333%;width:33.33333%;height:100%;border-right-width:1px;border-left-width:1px}
fieldset,hr,img,legend{border:0}
.cropper-center{position:absolute;top:50%;left:50%;width:0;height:0;opacity:.75;filter:alpha(opacity=75)}
.cropper-center:after,.cropper-center:before{position:absolute;content:" ";background-color:#eee}
.cropper-center:before{top:0;left:-3px;width:7px;height:1px}
.cropper-center:after{top:-3px;left:0;width:1px;height:7px}
.cropper-face,.cropper-line,.cropper-point{position:absolute;width:100%;height:100%;opacity:.1;filter:alpha(opacity=10)}
.cropper-face{top:0;left:0;background-color:#fff}
.cropper-line,.cropper-point{background-color:#69f}
.cropper-line.line-e{top:0;right:-3px;width:5px;cursor:e-resize}
.cropper-line.line-n{top:-3px;left:0;height:5px;cursor:n-resize}
.cropper-line.line-w{top:0;left:-3px;width:5px;cursor:w-resize}
.cropper-line.line-s{bottom:-3px;left:0;height:5px;cursor:s-resize}
.cropper-point{width:5px;height:5px;opacity:.75;filter:alpha(opacity=75)}
.cropper-point.point-e{top:50%;right:-3px;margin-top:-3px;cursor:e-resize}
.cropper-point.point-n{top:-3px;left:50%;margin-left:-3px;cursor:n-resize}
.cropper-point.point-w{top:50%;left:-3px;margin-top:-3px;cursor:w-resize}
.cropper-point.point-s{bottom:-3px;left:50%;margin-left:-3px;cursor:s-resize}
.cropper-point.point-ne{top:-3px;right:-3px;cursor:ne-resize}
.cropper-point.point-nw{top:-3px;left:-3px;cursor:nw-resize}
.cropper-point.point-sw{bottom:-3px;left:-3px;cursor:sw-resize}
.cropper-point.point-se{right:-3px;bottom:-3px;width:20px;height:20px;cursor:se-resize;opacity:1;filter:alpha(opacity=100)}
.cropper-point.point-se:before{position:absolute;right:-50%;bottom:-50%;width:200%;height:200%;content:" ";background-color:#69f;opacity:0;filter:alpha(opacity=0)}
@media (min-width:768px){.cropper-point.point-se{width:15px;height:15px}
}
@media (min-width:992px){.cropper-point.point-se{width:10px;height:10px}
}
@media (min-width:1200px){.cropper-point.point-se{width:5px;height:5px;opacity:.75;filter:alpha(opacity=75)}
}
.cropper-bg{background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXMzMz////TjRV2AAAACXBIWXMAAArrAAAK6wGCiw1aAAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M26LyyjAAAABFJREFUCJlj+M/AgBVhF/0PAH6/D/HkDxOGAAAAAElFTkSuQmCC)}
.cropper-invisible{opacity:0;filter:alpha(opacity=0)}
.cropper-hide{position:absolute;width:0;height:0}
.cropper-hidden{display:none!important}
.cropper-move{cursor:move}
.cropper-crop{cursor:crosshair}
.cropper-disabled .cropper-drag-box,.cropper-disabled .cropper-face,.cropper-disabled .cropper-line,.cropper-disabled .cropper-point{cursor:not-allowed}






    </style>
</head>
<body class="">
<div class="wrapper ">
    <h2>图片剪裁 cropper.js</h2>
    <div class="avatar-box" data-toggle="modal" data-target=".modal-change-avatar">
        <img src="http://7xjckn.com2.z0.glb.qiniucdn.com/default_face4.jpg">
    </div>
    <button type="button" class="btn-link c-primary" data-toggle="modal" data-target=".modal-change-avatar">修改头像</button>


</div>

<!-- 上传 -->
<div class="modal modal-change-avatar fade" data-mt="100" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="http://user.undm.cn/file/changephoto.html">
                <input type="hidden" name="basepath">
                <input type="hidden" name="x">
                <input type="hidden" name="y">
                <input type="hidden" name="w">
                <input type="hidden" name="h">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title">修改头像</h4>
                </div>

                <div class="modal-body">
                    <table class="up-avatar">
                        <tr>
                            <td class="crop-box">
                                <div class="pick-wrap">
                                    <div class="pick">选择图片</div>
                                    <div class="pick-helper">
                                        图片大小请勿超过1MB, 尺寸:<br>
                                        支持 JPG, PNG
                                    </div>
                                </div>
                                <div class="crop-wrap">
                                    <div class="img-wrap">
                                        <img>
                                    </div>
                                </div>
                            </td>
                            <td class="preview-box">
                                <div class="large"></div>
                                <div class="medium"></div>
                                <div class="small"></div>
                            </td>
                        </tr>
                        <tr>
                            <td class="toolbar">
                                <div class="re-pick">重新上传</div>
                            </td>
                            <td></td>
                        </tr>
                    </table>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn-primary" disabled>确定</button>
                    <button type="button" class="btn-o" data-dismiss="modal">取消</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script src="../assets/vendor/jquery/jquery-2.1.4.min.js"></script>
<script src="../assets/vendor/webuploader/webuploader.nolog.js"></script>
<script src="../assets/vendor/cropper/cropper.min.js"></script>
<script src="../assets/js/plugins/dm.modal.js"></script>


<script>
    

if (!WebUploader.Uploader.support()) {
    throw new Error('WebUploader does not support your browser.')
}
/*
 * $('form').upAvatar()
 *
 * */
!function ($) {
    var MAX_WIDTH = 410
        , isSupportBase64 = true

    !function () {
        var img = new Image
        img.onload = img.onerror = function () {
            if (this.width !== 1 || this.height !== 1) {
                isSupportBase64 = false
            }
        }
        img.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='
    }()

    $.fn.upAvatar = function (options) {
        return this.each(function () {
            var $form = $(this),
                $wu = $form.find('.up-avatar'),
                $pickWrap = $wu.find('.pick-wrap'),
                $cropWrap = $wu.find('.crop-wrap'),
                $image = $wu.find('.img-wrap img'),
                $preview = $wu.find('.preview-box').children(),
                $pick = $wu.find('.pick'),
                $basepath = $form.find('[name=basepath]'),
                $w = $form.find('[name=w]'),
                $h = $form.find('[name=h]'),
                $x = $form.find('[name=x]'),
                $y = $form.find('[name=y]'),
                $confirmBtn = $form.find(':submit'),
                oriPickHTML = $pickWrap.html(),
                file = null

            /*var uploader = new WebUploader.Uploader({
                pick: {
                    id: $pick,
                    multiple: false
                },
                chunked: false,
                compress: false,
                server: '/static/assets/data/upload.json',
                fileNumLimit: 1,
                onError: function () {
                    var args
                    args = [].slice.call(arguments, 0)
                    alert(args.join('\n'))
                },
                auto: true
            });
            
            var destroyPick = function () {
                uploader.destroy()
                $pickWrap.html(oriPickHTML)
            }
            var reset = function () {
                destroyPick()
                $image.cropper('destroy')
                $image.attr('src', '')
                $pickWrap.removeClass('webuploader-element-invisible')
                //$confirmBtn.disable(null, false)
            }
            var $modal = $form.closest('.modal').off('hide.reset').on('hide.reset', reset)
                .off('show.reset').on('show.reset', reset)
            uploader.on('uploadSuccess', function (_file, res) {
                $image.attr('src', res.data.url).cropper({
                    aspectRatio: 1,
                    preview: $preview,
                    crop: function (e) {
                        $w.val(e.width)
                        $h.val(e.height)
                        $x.val(e.x)
                        $y.val(e.y)
                    }
                })
                $pickWrap.addClass('webuploader-element-invisible')
                $basepath.val(res.data.url)
                //$confirmBtn.enable()
            })
            $form.off('success.closeModal').on('success.closeModal', function (e, json) {
                $modal.modal('hide')
                //dmAlert('修改成功')
            });*/

            // 
            $image.attr('src', '/static/assets/data/face1.jpg').cropper({
                aspectRatio: 1,
                preview: $preview,
                crop: function (e) {
                    $w.val(e.width)
                    $h.val(e.height)
                    $x.val(e.x)
                    $y.val(e.y)
                }
            });
        })
    }
}(jQuery)

// 修改头像
$(function () {
    var $modal = $('.modal-change-avatar'),
        $form = $modal.find('form'),
        $img = $('.avatar-box img')
    $modal.on('shown', function () {
        $form.upAvatar()
    })
    $form.on('success', function (e, json) {
        $img.attr('src', json.data.url)
    })

})

</script>

</body>
</html>